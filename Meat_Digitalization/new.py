# app.py ‚Äî –§–∏–Ω–∞–ª—å–Ω–∞—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –ø–æ–ª–∏–Ω–æ–º–∏–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª—å—é pH, –ø–æ–ª–Ω—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –∏ –Ω–æ–≤—ã–º —Ä–∞–∑–¥–µ–ª–æ–º –∞–Ω–∞–ª–∏–∑–∞
import pandas as pd
import numpy as np
import streamlit as st
from pathlib import Path
import matplotlib.pyplot as plt
import io
import json
# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è 'openpyxl' ---
try:
    import openpyxl
except ImportError:
    st.error(
        "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: 'openpyxl' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–µ, –≤—ã–ø–æ–ª–Ω–∏–≤ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∫–æ–º–∞–Ω–¥—É: pip install openpyxl")
    st.stop()

# ---------------------------
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –ø—É—Ç–µ–π –∫ –¥–∞–Ω–Ω—ã–º
# ---------------------------

st.set_page_config(page_title="–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ñ–∞—è", layout="wide")
DATA_DIR = Path(__file__).parent
MEAT_DATA_XLSX = DATA_DIR / "meat_data.xlsx"
OPYTY_XLSX = DATA_DIR / "opyty.xlsx"
# CSV —Ñ–∞–π–ª—ã –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞
PRODUCTS_CSV = DATA_DIR / "Products.csv"
SAMPLES_CSV = DATA_DIR / "Samples.csv"
MEASUREMENTS_CSV = DATA_DIR / "Measurements.csv"


# ---------------------------
# –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏ CSV
# ---------------------------
def safe_read_csv(path: Path):
    """
    –ü—ã—Ç–∞–µ—Ç—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å CSV-—Ñ–∞–π–ª, –ø–µ—Ä–µ–±–∏—Ä–∞—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–¥–∏—Ä–æ–≤–æ–∫ –∏ –ø–∞—Ä—Å–µ—Ä–æ–≤.
    """
    if not path.exists():
        return pd.DataFrame()

    encodings = ['utf-8-sig', 'utf-8', 'windows-1251', 'latin1']
    for enc in encodings:
        try:
            # –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å –±—ã—Å—Ç—Ä—ã–º 'c' –¥–≤–∏–∂–∫–æ–º
            return pd.read_csv(path, encoding=enc)
        except UnicodeDecodeError:
            # –ï—Å–ª–∏ –∫–æ–¥–∏—Ä–æ–≤–∫–∞ –Ω–µ–≤–µ—Ä–Ω–∞, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π
            continue
        except pd.errors.ParserError:
            # –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ (–∫–∞–∫ —É –≤–∞—Å), –ø—Ä–æ–±—É–µ–º –±–æ–ª–µ–µ –≥–∏–±–∫–∏–π 'python' –¥–≤–∏–∂–æ–∫
            try:
                st.warning(
                    f"–§–∞–π–ª '{path.name}' –∏–º–µ–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π. –ü–æ–ø—ã—Ç–∫–∞ —á—Ç–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é 'python' engine...")
                return pd.read_csv(path, encoding=enc, engine='python')
            except Exception as e:
                # –ï—Å–ª–∏ –∏ –æ–Ω –Ω–µ —Å–ø—Ä–∞–≤–∏–ª—Å—è, –ø—Ä–æ–±–ª–µ–º–∞ —Å–µ—Ä—å–µ–∑–Ω–∞—è
                st.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª '{path.name}' –¥–∞–∂–µ —Å 'python' engine. –û—à–∏–±–∫–∞: {e}")
                return pd.DataFrame()
        except Exception as e:
            st.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ '{path.name}': {e}")
            return pd.DataFrame()

    # –ï—Å–ª–∏ –Ω–∏ –æ–¥–Ω–∞ –∫–æ–¥–∏—Ä–æ–≤–∫–∞ –Ω–µ –ø–æ–¥–æ—à–ª–∞
    st.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–¥–∏—Ä–æ–≤–∫—É –∏ –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª '{path.name}'.")
    return pd.DataFrame()


def append_row_csv(path: Path, row: dict, cols_order=None):
    df_new = pd.DataFrame([row])
    write_header = not path.exists() or path.stat().st_size == 0
    if cols_order:
        for c in cols_order:
            if c not in df_new.columns: df_new[c] = ""
        df_new = df_new[cols_order]
    df_new.to_csv(path, mode='a', index=False, header=write_header, encoding='utf-8-sig')


# ---------------------------
# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
# ---------------------------
@st.cache_data
def load_all_data():
    data_sheets = {}
    try:
        if MEAT_DATA_XLSX.exists():
            xls = pd.ExcelFile(MEAT_DATA_XLSX)
            for sheet_name in xls.sheet_names:
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º openpyxl –¥–ª—è —á—Ç–µ–Ω–∏—è XLSX
                data_sheets[sheet_name] = pd.read_excel(xls, sheet_name=sheet_name, engine='openpyxl')
    except Exception as e:
        st.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å '{MEAT_DATA_XLSX.name}': {e}")

    df_ph = None
    if OPYTY_XLSX.exists():
        try:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º openpyxl –¥–ª—è —á—Ç–µ–Ω–∏—è XLSX
            df_ph = pd.read_excel(OPYTY_XLSX, engine='openpyxl')
        except Exception as e:
            st.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å '{OPYTY_XLSX.name}': {e}")

    products_df = safe_read_csv(PRODUCTS_CSV)
    samples_df = safe_read_csv(SAMPLES_CSV)
    measurements_df = safe_read_csv(MEASUREMENTS_CSV)

    return data_sheets, df_ph, products_df, samples_df, measurements_df


all_meat_data, df_ph, products, samples, measurements = load_all_data()


# ---------------------------
# –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–æ–¥–µ–ª–∏
# ---------------------------
def calculate_stability(pressure, viscosity):
    p, v = pressure, viscosity
    return 27.9 - 0.1 * p - 1.94 * v - 0.75 * p * v - 0.67 * p ** 2 - 2.5 * v ** 2


def get_ph_model(time_h, ph_obs):
    """–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–ª–∏–Ω–æ–º–∏–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å 2-–π —Å—Ç–µ–ø–µ–Ω–∏: pH = at^2 + bt + c."""
    valid = ~np.isnan(time_h) & ~np.isnan(ph_obs)
    t, y = time_h[valid], ph_obs[valid]
    if len(t) < 3: return None, None, None, None
    coeffs = np.polyfit(t, y, 2)
    model_function = np.poly1d(coeffs)
    y_hat = model_function(t)
    r2 = 1 - (np.sum((y - y_hat) ** 2) / np.sum((y - np.mean(y)) ** 2))
    rmse = np.sqrt(np.mean((y - y_hat) ** 2))
    return model_function, y_hat, rmse, r2


# ---------------------------
# –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏
# ---------------------------
st.sidebar.title("–ú–µ–Ω—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã")
page_options = ["–ì–ª–∞–≤–Ω–∞—è", "–ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –ñ–∞—è", "–†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –∫–∞—á–µ—Å—Ç–≤–∞", "–ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ pH",
                "–ê–Ω–∞–ª–∏–∑ —Å —ç–∫—Å—Ç—Ä–∞–∫—Ç–æ–º –æ–±–ª–µ–ø–∏—Ö–∏", "–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö","–í–≤–æ–¥ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö"]
page = st.sidebar.radio("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:", page_options)

if 'selected_product_id' not in st.session_state: st.session_state.selected_product_id = None
if 'selected_step' not in st.session_state: st.session_state.selected_step = None

# ==========================================================================
# –°–¢–†–ê–ù–ò–¶–ê 1: –ì–õ–ê–í–ù–ê–Ø
# ==========================================================================
if page == "–ì–ª–∞–≤–Ω–∞—è":
    st.title("üêé –¶–∏—Ñ—Ä–æ–≤–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –∏ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ñ–∞—è")
    st.write(
        "–≠—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–¥—É–∫—Ü–∏–∏.")
    st.info("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –≤ –º–µ–Ω—é —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É.")

# ==========================================================================
# –°–¢–†–ê–ù–ò–¶–ê 2: –ü–†–û–¶–ï–°–° –ü–†–û–ò–ó–í–û–î–°–¢–í–ê –ñ–ê–Ø (–¢–û–õ–¨–ö–û –†–£–°–°–ö–ò–ô –Ø–ó–´–ö, KPI –í –ü–†–ò–ï–ú–ö–ï)
# ==========================================================================
elif page == "–ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –ñ–∞—è":
    st.title("üçñ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –ñ–∞—è")
    st.markdown("### –ü–æ—à–∞–≥–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ—Ü–µ—Å—Å–∞")

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç–∞–¥–∏–µ–π
    if 'active_stage_clean' not in st.session_state:
        st.session_state['active_stage_clean'] = 'priemka'

    # ------------------ –ù–∞–≤–∏–≥–∞—Ü–∏—è –ö–Ω–æ–ø–∫–∞–ª–∞—Ä—ã ------------------
    col1, col2, col3, col4 = st.columns(4)

    with col1:
        if st.button("1. –ü—Ä–∏–µ–º–∫–∞ —Å—ã—Ä—å—è ü•©", key='btn_priemka'):
            st.session_state['active_stage_clean'] = 'priemka'
    with col2:
        if st.button("2. –ü–æ—Å–æ–ª –∏ –º–∞—Å—Å–∏—Ä–æ–≤–∞–Ω–∏–µ üßÇ", key='btn_posol'):
            st.session_state['active_stage_clean'] = 'posol'
    with col3:
        if st.button("3. –¢–µ—Ä–º–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ üî•", key='btn_termo'):
            st.session_state['active_stage_clean'] = 'termokamera'
    with col4:
        if st.button("4. –•—Ä–∞–Ω–µ–Ω–∏–µ –∏ —É–ø–∞–∫–æ–≤–∫–∞ üì¶", key='btn_upakovka'):
            st.session_state['active_stage_clean'] = 'upakovka'

    st.markdown("---")

    active_stage = st.session_state.get('active_stage_clean')

    # ------------------ 1. –ü—Ä–∏–µ–º–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å—ã—Ä—å—è (–ï–Ω–¥—ñ KPI –æ—Å—ã –∂–µ—Ä–¥–µ) ------------------
    if active_stage == 'priemka':
        st.header("1. –ü—Ä–∏–µ–º–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å—ã—Ä—å—è")

        with st.expander("–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏–µ–º–∫–∏", expanded=True):
            col_p1, col_p2, col_p3 = st.columns(3)
            col_p1.metric(label="–ù–∞—á–∞–ª—å–Ω–∞—è –º–∞—Å—Å–∞", value="1 –∫–≥")
            col_p2.metric(label="–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Å—ã—Ä—å—è", value="0-3¬∞–°")
            col_p3.metric(label="–¢–æ–ª—â–∏–Ω–∞ –∂–∏—Ä–∞", value="1,5 —Å–º ‚Äì 2 —Å–º")

            st.markdown("""
            **–û—Ä–≥–∞–Ω–æ–ª–µ–ø—Ç–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞:** –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è **—Ü–≤–µ—Ç, –≤–∫—É—Å, –∑–∞–ø–∞—Ö** –∏ **–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ü–∏—è**.
            """)

            # --- –ñ–∞“£–∞ KPI-–Ω—ã –æ—Å—ã expender-–¥—ñ“£ —ñ—à—ñ–Ω–µ –µ–Ω–≥—ñ–∑–µ–º—ñ–∑ ---
            st.markdown("#### –ö–ª—é—á–µ–≤—ã–µ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (–û–±—â–∞—è —Å–≤–æ–¥–∫–∞)")

            col_kpi_a, col_kpi_b, col_kpi_c = st.columns(3)

            col_kpi_a.metric(
                label="–í—ã—Ö–æ–¥ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ (–¶–µ–ª—å)",
                value="85%",
                delta="–ü–æ –ì–û–°–¢"
            )
            col_kpi_b.metric(
                label="–¶–µ–ª–µ–≤–∞—è t¬∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏",
                value="74¬∞–°",
                delta="–í–Ω—É—Ç—Ä–∏ –ø—Ä–æ–¥—É–∫—Ç–∞"
            )
            col_kpi_c.metric(
                label="–ú–∞—Å—Å–∞ —Ä–∞—Å—Å–æ–ª–∞ (–ü–æ—Ç–µ—Ä—è)",
                value="100 –≥",
                delta_color="off"
            )

            st.markdown("---")
            st.markdown("–î–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —ç—Ç–∞–ø–∞–º (–ü–æ—Å–æ–ª, –¢–µ—Ä–º–æ–æ–±—Ä–∞–±–æ—Ç–∫–∞).")

    # ------------------ 2. –ü–æ—Å–æ–ª –∏ –º–∞—Å—Å–∏—Ä–æ–≤–∞–Ω–∏–µ ------------------
    elif active_stage == 'posol':
        st.header("2. –ü–æ—Å–æ–ª, –®–ø—Ä–∏—Ü–µ–≤–∞–Ω–∏–µ –∏ –ú–∞—Å—Å–∏—Ä–æ–≤–∞–Ω–∏–µ")

        with st.expander("–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–∞—Å—Å–æ–ª–∞ –∏ —à–ø—Ä–∏—Ü–µ–≤–∞–Ω–∏–µ", expanded=True):
            st.markdown(r"""
            **–°–æ—Å—Ç–∞–≤ —Ä–∞—Å—Å–æ–ª–∞:** 4,5 –ª $\text{H}_2\text{O}$ + 250 –≥ $\text{NaCl}$ + 0,8 –º–≥ $\text{NaNO}_2$.
            * **–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Ä–∞—Å—Å–æ–ª–∞:** **$16^{\circ}–°$**
            * **–®–ø—Ä–∏—Ü–µ–≤–∞–Ω–∏–µ:** –î–æ —Å–µ—Ä–µ–¥–∏–Ω—ã –∫—É—Å–∫–∞. –ò–≥–ª—ã: **50 –º–º –∏ 80 –º–º**.
            * **–£–∫–ª–∞–¥–∫–∞ –≤ —Ä–∞—Å—Å–æ–ª:** $\tau=72$ —á–∞—Å–∞, $t=0-3^{\circ}–°$. –î–∞–≤–ª–µ–Ω–∏–µ $P=1200\text{ –≥} ‚Äì 1250\text{ –≥}$ –Ω–∞ 1000 –≥.
            """)

        with st.expander("–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞—Å—Å–∏—Ä–æ–≤–∞–Ω–∏—è", expanded=False):
            col_m1, col_m2 = st.columns(2)
            col_m1.metric(label="–û–±—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å", value="3 —á–∞—Å–∞")
            col_m2.metric(label="–†–∞–±–æ—á–µ–µ –¥–∞–≤–ª–µ–Ω–∏–µ", value="0,4-0,5 –∫–≥/—Å–º¬≤ (max 0,9)")

            st.markdown(r"""
            * **–ü–æ—Ç–µ—Ä—è –º–∞—Å—Å—ã (–∑–∞ 2 —á–∞—Å–∞):** –°–Ω–∏–∂–µ–Ω–∏–µ $\text{H}_2\text{O}$ –Ω–∞ $\mathbf{100\text{ –≥}}$ (–æ—Ç $1250\text{ –≥}$).
            * **–ò—Ç–æ–≥–æ–≤–∞—è –º–∞—Å—Å–∞:** $1150\text{ –≥}$.
            """)

    # ------------------ 3. –¢–µ—Ä–º–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ ------------------
    elif active_stage == 'termokamera':
        st.header("3. –¢–µ—Ä–º–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (–¢–µ—Ä–º–æ–∫–∞–º–µ—Ä–∞)")
        st.info("–¢–µ—Ä–º–æ–æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∫–ª—é—á–∞–µ—Ç 5 –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤.")

        # DataFrame “Ø—à—ñ–Ω –¥–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –¥–∞–π—ã–Ω–¥–∞—É (pandas –∏–º–ø–æ—Ä—Ç—ã –±–∞—Ä –¥–µ–ø –µ—Å–µ–ø—Ç–µ–π–º—ñ–∑)
        termoparameters = [
            ("–°—É—à–∫–∞", "45¬∞–°", "20 –º–∏–Ω", "–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω–æ–π –≤–ª–∞–≥–∏."),
            ("–û–±–∂–∞—Ä–∫–∞", "75-85¬∞–°", "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è $\mathbf{60^{\circ}–°}$", "–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–∞/–∞—Ä–æ–º–∞—Ç–∞."),
            ("–í–∞—Ä–∫–∞ –ø–∞—Ä–æ–º", "–ö–∞–º–µ—Ä–∞ $\mathbf{88^{\circ}–°}$", "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è $\mathbf{74^{\circ}–°}$",
             "–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏."),
            ("–°—É—à–∫–∞ –æ—Ö–ª–∞–∂–¥–µ–Ω–∏–µ–º", "–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä", "10 –º–∏–Ω", "–°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã."),
            ("–ö–æ–ø—á–µ–Ω–∏–µ", "30-33¬∞–° (–î—ã–º)", "1,5 —á–∞—Å–∞", "–ü—Ä–∏–¥–∞–Ω–∏–µ –∞—Ä–æ–º–∞—Ç–∞ (–ö–æ–ø—Ç–∏–ª—å–Ω—è $230^{\circ}–°$).")
        ]

        # st.dataframe –∞—Ä“õ—ã–ª—ã –∫”©—Ä—Å–µ—Ç—É
        try:
            df_termo = pd.DataFrame(termoparameters, columns=["–≠—Ç–∞–ø", "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞", "–í—Ä–µ–º—è/–ö—Ä–∏—Ç–µ—Ä–∏–π", "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ"])
            st.dataframe(df_termo.set_index('–≠—Ç–∞–ø'), width=800)
        except NameError:
            # –ï–≥–µ—Ä pandas –∏–º–ø–æ—Ä—Ç—ã –±–æ–ª–º–∞—Å–∞, –º”ô—Ç—ñ–Ω —Ä–µ—Ç—ñ–Ω–¥–µ —à—ã“ì–∞—Ä–∞–º—ã–∑
            st.warning("–î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º –∏–º–ø–æ—Ä—Ç: import pandas as pd –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞.")
            for etapa, t, tau, naznachenie in termoparameters:
                st.markdown(f"**{etapa}:** $t={t}$, $\tau={tau}$ ($ {naznachenie} $)")

        st.markdown("---")
        st.markdown("**–ü–æ—Å–ª–µ –∫–æ–ø—á–µ–Ω–∏—è:** –ñ–∞—è –æ—Å—Ç–∞–µ—Ç—Å—è –≤ —Ç–µ—Ä–º–æ–∫–∞–º–µ—Ä–µ —Å **–æ—Ç–∫—Ä—ã—Ç–æ–π –¥–≤–µ—Ä—å—é –≤ —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤**.")

    # ------------------ 4. –•—Ä–∞–Ω–µ–Ω–∏–µ –∏ —É–ø–∞–∫–æ–≤–∫–∞ ------------------
    elif active_stage == 'upakovka':
        st.header("4. –û–±–≤–∞–ª–∫–∞, –£–ø–∞–∫–æ–≤–∫–∞ –∏ –•—Ä–∞–Ω–µ–Ω–∏–µ")

        with st.expander("–û–±–≤–∞–ª–∫–∞ –∏ –£–ø–∞–∫–æ–≤–∫–∞", expanded=True):
            st.markdown("""
            * **–§–æ—Ä–º–æ–≤–∫–∞ (–û–±–≤–∞–ª–∫–∞):** –®–ø–∞–≥–∞—Ç–æ–º (–∫—Ä—É–≥–ª–∞—è/–ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞) ‚Äî $\tau=20$ –º–∏–Ω.
            * **–û—Ö–ª–∞–∂–¥–µ–Ω–∏–µ:** –í —Ö–æ–ª–æ–¥–∏–ª—å–Ω–æ–π –∫–∞–º–µ—Ä–µ $t=0-5^{\circ}–°$ ‚Äî $12$ —á–∞—Å–æ–≤.
            * **–£–¥–∞–ª–µ–Ω–∏–µ —à–ø–∞–≥–∞—Ç–∞:** –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –ø–æ—Å–ª–µ –æ—Ö–ª–∞–∂–¥–µ–Ω–∏—è.
            * **–£–ø–∞–∫–æ–≤–∫–∞:** –í –≤–∞–∫—É—É–º-—É–ø–∞–∫–æ–≤–æ—á–Ω–æ–º –∞–≤—Ç–æ–º–∞—Ç–µ.
            """)

        with st.expander("–°—Ä–æ–∫–∏ –∏ –í—ã—Ö–æ–¥ –ø—Ä–æ–¥—É–∫—Ç–∞", expanded=True):
            st.metric(label="–í—ã—Ö–æ–¥ –≥–æ—Ç–æ–≤–æ–π –ø—Ä–æ–¥—É–∫—Ü–∏–∏ (–ø–æ –ì–û–°–¢)", value="85%")

            st.markdown("**–°—Ä–æ–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è:**")
            st.markdown("* **–°—Ç–∞–Ω–¥–∞—Ä—Ç:** $t=0-3^{\circ}–°$ ‚Äî $\mathbf{30}$ —Å—É—Ç–æ–∫.")
            st.markdown(
                "* **–ó–∞–º–æ—Ä–æ–∑–∫–∞:** –ü–æ—Å–ª–µ 72 —á–∞—Å–æ–≤ ($0-3^{\circ}–°$) –≤ –º–æ—Ä–æ–∑–∏–ª—å–Ω–∏–∫ $t = -16\div-18^{\circ}–°$ ‚Äî $\mathbf{6}$ –º–µ—Å—è—Ü–µ–≤.")
# ==========================================================================
# –°–¢–†–ê–ù–ò–¶–ê 3: –†–ï–ì–†–ï–°–°–ò–û–ù–ù–´–ï –ú–û–î–ï–õ–ò –ö–ê–ß–ï–°–¢–í–ê (–¢–û–õ–¨–ö–û –†–£–°–°–ö–ò–ô –Ø–ó–´–ö)
# ==========================================================================
elif page == "–†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –∫–∞—á–µ—Å—Ç–≤–∞":
    st.title("üìä –†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–Ω–µ—á–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞")
    st.markdown("### –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤")

    with st.expander("‚ÑπÔ∏è –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ", expanded=True):
        st.write("""
            **–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–æ–¥–µ–ª–∏** –ø–æ–∑–≤–æ–ª—è—é—Ç –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –≥–æ—Ç–æ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ (–≤–ª–∞–∂–Ω–æ—Å—Ç—å, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤–æ–¥—ã, –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ—á–Ω–æ—Å—Ç—å, —Ü–≤–µ—Ç–æ–≤–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å), –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ **—É–ø—Ä–∞–≤–ª—è—é—â–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–∞—Ö** –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –≤—Ä–µ–º—è —Å—É—à–∫–∏, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è —ç–∫—Å—Ç—Ä–∞–∫—Ç–∞ –∏ –¥—Ä.).

            **–ö–ª—é—á–µ–≤—ã–µ –º–æ–¥–µ–ª–∏ –≤ –û—Ç—á–µ—Ç–µ:** –í–ª–∞–∂–Ω–æ—Å—Ç—å –∫–æ–Ω–µ—á–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞, –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤–æ–¥—ã, –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ—á–Ω–æ—Å—Ç—å.
        """)

    st.markdown("---")

    # --- 1. –í–õ–ê–ñ–ù–û–°–¢–¨ (W) –ú–æ–¥–µ–ª—å ---
    st.header("1. –í–ª–∞–∂–Ω–æ—Å—Ç—å –∫–æ–Ω–µ—á–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ ($W$)")

    # –§–æ—Ä–º—É–ª—É –∏–º–∏—Ç–∏—Ä—É–µ–º, –∏—Å–ø–æ–ª—å–∑—É—è –¥–∞–Ω–Ω—ã–µ –∏–∑ –û—Ç—á–µ—Ç–∞ (—Å—Ç—Ä. 6)
    st.latex(r"""
        W = 65.0 + 0.12 \cdot T - 0.05 \cdot H + 0.5 \cdot E
    """)
    st.markdown("""
        * $W$ - –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å, %
        * $T$ - –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Å—É—à–∫–∏, $^\circ C$
        * $H$ - –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å—É—à–∫–∏, —á–∞—Å
        * $E$ - –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è —ç–∫—Å—Ç—Ä–∞–∫—Ç–∞ –æ–±–ª–µ–ø–∏—Ö–∏, %
    """)

    col_w1, col_w2, col_w3 = st.columns(3)
    with col_w1:
        T = st.slider("–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Å—É—à–∫–∏ (T), ¬∞C", min_value=20, max_value=35, value=25, step=1, key="w_T")
    with col_w2:
        H = st.slider("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å—É—à–∫–∏ (H), —á–∞—Å", min_value=1.0, max_value=10.0, value=5.0, step=0.5, key="w_H")
    with col_w3:
        E = st.slider("–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è —ç–∫—Å—Ç—Ä–∞–∫—Ç–∞ (E), %", min_value=0.0, max_value=5.0, value=3.0, step=0.5, key="w_E")

    # –†–∞—Å—á–µ—Ç
    W_predicted = 65.0 + 0.12 * T - 0.05 * H + 0.5 * E

    st.metric(
        label="–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–∞—è –í–ª–∞–∂–Ω–æ—Å—Ç—å (W), %",
        value=f"{W_predicted:.2f}",
        delta=f"–†–∞–∑–Ω–∏—Ü–∞ –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è (65%): {W_predicted - 65.0:.2f} –ø.–ø."
    )
    st.info(
        "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–∫—Å—Ç—Ä–∞–∫—Ç–∞ ($E$) –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–ª–∞–≥–æ—É–¥–µ—Ä–∂–∞–Ω–∏–µ, –∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å—É—à–∫–∏ ($H$) —Å–Ω–∏–∂–∞–µ—Ç –≤–ª–∞–∂–Ω–æ—Å—Ç—å.")

    st.markdown("---")

    # --- 2. –ê–ö–¢–ò–í–ù–û–°–¢–¨ –í–û–î–´ (Aw) –ú–æ–¥–µ–ª—å ---
    st.header("2. –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤–æ–¥—ã ($A_w$)")

    # –û—Ç—á–µ—Ç—Ç–∞–Ω –∞–ª—ã–Ω“ì–∞–Ω —Ñ–æ—Ä–º—É–ª–∞–Ω—ã –∏–º–∏—Ç–∞—Ü–∏—è–ª–∞—É
    st.latex(r"""
        A_w = 0.95 - 0.003 \cdot C - 0.005 \cdot T_s
    """)
    st.markdown("""
        * $A_w$ - –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤–æ–¥—ã (–ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –º–∏–∫—Ä–æ–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏)
        * $C$ - –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è —Å–æ–ª–∏ –≤ —Ä–∞—Å—Å–æ–ª–µ, %
        * $T_s$ - –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–ª–µ–Ω–∏—è, —Å—É—Ç
    """)

    col_a1, col_a2 = st.columns(2)
    with col_a1:
        C = st.slider("–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è —Å–æ–ª–∏ (C), %", min_value=2.0, max_value=6.0, value=4.0, step=0.2, key="a_C")
    with col_a2:
        Ts = st.slider("–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–ª–µ–Ω–∏—è (Ts), —Å—É—Ç", min_value=1.0, max_value=7.0, value=3.0, step=0.5, key="a_Ts")

    # –†–∞—Å—á–µ—Ç
    Aw_predicted = 0.95 - 0.003 * C - 0.005 * Ts

    st.metric(
        label="–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–∞—è –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤–æ–¥—ã ($A_w$)",
        value=f"{Aw_predicted:.3f}",
        delta=f"–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–Ω–∏–∑–∏—Ç—å –Ω–∞ {Aw_predicted - 0.90:.3f} –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è Aw ‚â§ 0.90" if Aw_predicted > 0.90 else "–í –ø—Ä–µ–¥–µ–ª–∞—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –Ω–æ—Ä–º—ã"
    )
    st.success("–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π $A_w$ (0.88-0.90) –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è –º–∏–∫—Ä–æ–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ–¥–ª–µ–Ω–∏—è —Å—Ä–æ–∫–∞ –≥–æ–¥–Ω–æ—Å—Ç–∏.")

    st.markdown("---")

    # --- 3. –¶–í–ï–¢–û–í–ê–Ø –°–¢–ê–ë–ò–õ–¨–ù–û–°–¢–¨ (New Section) ---
    st.header("3. –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å ($\Delta E$)")

    st.info("""
    –ú–æ–¥–µ–ª—å **–¶–≤–µ—Ç–æ–≤–æ–π —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏** –æ–ø–∏—Å—ã–≤–∞–µ—Ç, –∫–∞–∫ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è —Ü–≤–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–∞ (–ø–∞—Ä–∞–º–µ—Ç—Ä $\Delta E$ - –æ–±—â–µ–µ —Ü–≤–µ—Ç–æ–≤–æ–µ —Ä–∞–∑–ª–∏—á–∏–µ) –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ö—Ä–∞–Ω–µ–Ω–∏—è.
    –¶–µ–ª—å –º–æ–¥–µ–ª–∏: –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å $\Delta E$ (–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞) –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–Ω–æ–≥–æ –≤–∏–¥–∞.
    """)

    with st.expander("–ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã —Ü–≤–µ—Ç–æ–≤–æ–π —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏:", expanded=True):
        col_c1, col_c2 = st.columns(2)

        col_c1.metric(label="–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è —ç–∫—Å—Ç—Ä–∞–∫—Ç–∞ ($E$)", value="–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ",
                      delta="–ê–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç—ã —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É—é—Ç —Ü–≤–µ—Ç")
        col_c2.metric(label="–ü–µ—Ä–µ–∫–∏—Å–Ω–æ–µ —á–∏—Å–ª–æ ($PV$)", value="–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ",
                      delta="–û–∫–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø–æ—Ç–µ—Ä–µ —Ü–≤–µ—Ç–∞", delta_color="inverse")

        st.markdown("---")
        st.markdown("""
        **–û—Å–Ω–æ–≤–Ω–æ–π –≤—ã–≤–æ–¥:** –î–æ–±–∞–≤–ª–µ–Ω–∏–µ **—ç–∫—Å—Ç—Ä–∞–∫—Ç–∞ –æ–±–ª–µ–ø–∏—Ö–∏** ($E$) –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —Å–Ω–∏–∂–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –æ–∫–∏—Å–ª–µ–Ω–∏—è (—É–º–µ–Ω—å—à–∞–µ—Ç $PV$), —Ç–µ–º —Å–∞–º—ã–º **–ø–æ–≤—ã—à–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∫—Ä–∞—Å–Ω–æ–≥–æ –∏ –∂–µ–ª—Ç–æ–≥–æ –æ—Ç—Ç–µ–Ω–∫–æ–≤**, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã—Ö –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –º—è—Å–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞.
        """)

    st.markdown("---")

    # --- 4. –ú–ï–•–ê–ù–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ß–ù–û–°–¢–¨ (–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Å–∏–º—É–ª—è—Ç–æ—Ä) ---
    st.header("4. –ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ—á–Ω–æ—Å—Ç—å (—Ñ–æ—Ä–º–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–¥–µ–ª–∏—è)")

    st.info(
        "–ú–æ–¥–µ–ª—å –æ–ø–∏—Å—ã–≤–∞–µ—Ç **–ø–ª–æ—Ç–Ω–æ—Å—Ç—å –∏ —É–ø—Ä—É–≥–æ—Å—Ç—å** –ø—Ä–æ–¥—É–∫—Ç–∞, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è —Å–µ–ø–∞—Ä–∞—Ü–∏—é. –ó–¥–µ—Å—å –º—ã –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ–º **–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ** –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤.")

    with st.expander("üõ†Ô∏è –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Å–∏–º—É–ª—è—Ç–æ—Ä –ø—Ä–æ—á–Ω–æ—Å—Ç–∏", expanded=True):

        # –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã —Å –ø–æ–ª–∑—É–Ω–∫–∞–º–∏ (sliders)
        col_p_slider, col_v_slider = st.columns(2)

        with col_p_slider:
            # P - –î–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ—Å—Å–æ–≤–∞–Ω–∏—è (–§–∞–∫—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –º—ã –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º)
            P_input = st.slider(
                "–î–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ—Å—Å–æ–≤–∞–Ω–∏—è ($P$), $–∫–≥/—Å–º^2$",
                min_value=0.5, max_value=2.0, value=1.0, step=0.1, key="p_pressure"
            )

        with col_v_slider:
            # V - –í—è–∑–∫–æ—Å—Ç—å —Ñ–∞—Ä—à–∞ (–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä)
            V_input = st.slider(
                "–í—è–∑–∫–æ—Å—Ç—å —Ñ–∞—Ä—à–∞ ($V$), —É—Å–ª–æ–≤–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã",
                min_value=50, max_value=150, value=100, step=10, key="v_viscosity"
            )

        # ------------------------------------------------------------------
        # –ò–º–∏—Ç–∞—Ü–∏—è —Ñ–æ—Ä–º—É–ª—ã –ø—Ä–æ—á–Ω–æ—Å—Ç–∏ (–û–ë–†–ê–¢–ù–ê–Ø –ó–ê–í–ò–°–ò–ú–û–°–¢–¨)
        # –ü—Ä–æ—á–Ω–æ—Å—Ç—å —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–æ—Å—Ç–µ P –∏ V. –ë–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å = 100.
        # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ø–æ–¥–æ–±—Ä–∞–Ω—ã –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞.
        # ------------------------------------------------------------------

        # –£—Å–ª–æ–≤–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞: –ü—Ä–æ—á–Ω–æ—Å—Ç—å = 120 - (5 * P) - (0.2 * V)
        # –ë–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å (P=1.0, V=100) –¥–∞—Å—Ç: 120 - 5 - 20 = 95

        Base_Prochnost = 120.0
        # –®—Ç—Ä–∞—Ñ—ã
        Penalty_P = 5.0 * P_input
        Penalty_V = 0.2 * V_input

        Prochnost_predicted = Base_Prochnost - Penalty_P - Penalty_V

        # –£—Å–ª–æ–≤–Ω–∞—è —à–∫–∞–ª–∞
        if Prochnost_predicted >= 95:
            delta_text = "–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è/–í—ã—Å–æ–∫–∞—è –ø—Ä–æ—á–Ω–æ—Å—Ç—å"
            delta_color = "normal"
        elif Prochnost_predicted >= 80:
            delta_text = "–°—Ä–µ–¥–Ω—è—è –ø—Ä–æ—á–Ω–æ—Å—Ç—å (–ü—Ä–∏–µ–º–ª–µ–º–æ)"
            delta_color = "off"
        else:
            delta_text = "–ù–∏–∑–∫–∞—è –ø—Ä–æ—á–Ω–æ—Å—Ç—å (–†–∏—Å–∫ —Å–µ–ø–∞—Ä–∞—Ü–∏–∏)"
            delta_color = "inverse"  # –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç

        st.markdown("---")

        st.metric(
            label="–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π –ò–Ω–¥–µ–∫—Å –ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–æ–π –ü—Ä–æ—á–Ω–æ—Å—Ç–∏ (–£—Å–ª. –µ–¥.)",
            value=f"{Prochnost_predicted:.1f}",
            delta=delta_text,
            delta_color=delta_color
        )

        st.markdown(r"""
           **–ê–Ω–∞–ª–∏–∑ —Å–∏–º—É–ª—è—Ç–æ—Ä–∞:** * **–£–≤–µ–ª–∏—á–µ–Ω–∏–µ $P$ –∏–ª–∏ $V$** –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ **—Å–Ω–∏–∂–µ–Ω–∏—é** –∏–Ω–¥–µ–∫—Å–∞ –ø—Ä–æ—á–Ω–æ—Å—Ç–∏, —á—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç **–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ** —ç—Ç–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤, –∫–∞–∫ —É–∫–∞–∑–∞–Ω–æ –≤ –æ—Ç—á–µ—Ç–µ.
           * –¶–µ–ª–µ–≤–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω –ø—Ä–æ—á–Ω–æ—Å—Ç–∏ (–í—ã—Å–æ–∫–∞—è): $\mathbf{95+}$.

           *–í—ã–≤–æ–¥ –ø–æ –û—Ç—á–µ—Ç—É:* **–û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ** ($P \approx 1.0$ –∏ $V \approx 100$) –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–µ–ø–∞—Ä–∞—Ü–∏—é.
           """)

    st.markdown("---")

    # --- 5. –ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò (New Conclusion) ---
    st.header("5. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é —ç–∫—Å—Ç—Ä–∞–∫—Ç–∞ –æ–±–ª–µ–ø–∏—Ö–∏")

    st.success("üéØ –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è —ç–∫—Å—Ç—Ä–∞–∫—Ç–∞ (–ó–∞–∫–ª—é—á–µ–Ω–∏–µ –û—Ç—á–µ—Ç–∞, —Å—Ç—Ä. 18)")

    col_conc1, col_conc2 = st.columns(2)

    col_conc1.metric(label="–î–ª—è —Ü–µ–ª—å–Ω–æ–º—ã—à–µ—á–Ω–æ–π –∂–∞—è (–∫–æ–ø—á—ë–Ω–æ–π)", value="5%",
                     delta="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∞–Ω—Ç–∏–æ–∫–∏—Å–ª–∏—Ç–µ–ª—å–Ω–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å")
    col_conc2.metric(label="–î–ª—è —Ñ–æ—Ä–º–æ–≤–∞–Ω–Ω–æ–≥–æ –º—è—Å–Ω–æ–≥–æ –∏–∑–¥–µ–ª–∏—è", value="3%", delta="–ë–∞–ª–∞–Ω—Å –≤–∫—É—Å–∞ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω–æ—Å—Ç–∏")

    st.markdown("""
    **–û–±—â–µ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ:** –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —ç–∫—Å—Ç—Ä–∞–∫—Ç–∞ –æ–±–ª–µ–ø–∏—Ö–∏ –≤ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è—Ö **3‚Äì5%** —è–≤–ª—è–µ—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º **–ø–æ–≤—ã—Å–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ —Å—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏** –º—è—Å–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –æ–±–æ–≥–∞—â–∞—è –∏—Ö **–Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–º–∏ –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç–∞–º–∏** –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏—Ö –¥–æ–±–∞–≤–æ–∫.
    """)
# ==========================================================================
# –°–¢–†–ê–ù–ò–¶–ê 4: –ú–û–î–ï–õ–ò–†–û–í–ê–ù–ò–ï PH (–¢–û–õ–´“ö –ñ–ê–ù–ê–†–¢–´–õ“í–ê–ù –û–†–´–°–®–ê –ù“∞–°“ö–ê)
# ==========================================================================
elif page == "–ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ pH":
    st.title("üå°Ô∏è –ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ pH –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–æ—Å–æ–ª–∞")
    st.markdown("### –ü—Ä–æ–≥–Ω–æ–∑ –∫–∏–Ω–µ—Ç–∏–∫–∏ –∫–∏—Å–ª–æ—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏")

    # --- –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ ---
    with st.expander("‚ÑπÔ∏è –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ pH-–º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è", expanded=True):
        st.write("""
            **–ë–∏–æ—Ö–∏–º–∏—á–µ—Å–∫–∏–π —Å–º—ã—Å–ª:** –°–Ω–∏–∂–µ–Ω–∏–µ pH (–∑–∞–∫–∏—Å–ª–µ–Ω–∏–µ) –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –±–ª–∞–≥–æ–¥–∞—Ä—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ **–º–æ–ª–æ—á–Ω–æ–∫–∏—Å–ª—ã—Ö –±–∞–∫—Ç–µ—Ä–∏–π** (–ú–ö–ë) –∏ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—é –º–æ–ª–æ—á–Ω–æ–π –∫–∏—Å–ª–æ—Ç—ã. –≠—Ç–æ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω –¥–ª—è:
            1.  **–ú–∏–∫—Ä–æ–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:** pH –Ω–∏–∂–µ 5.6 –∏–Ω–≥–∏–±–∏—Ä—É–µ—Ç —Ä–æ—Å—Ç –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –ø–∞—Ç–æ–≥–µ–Ω–æ–≤, –≤–∫–ª—é—á–∞—è **Clostridium botulinum**.
            2.  **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –°–≤–æ–π—Å—Ç–≤:** –ü—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ pH –∫ –∏–∑–æ—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–æ–π —Ç–æ—á–∫–µ –±–µ–ª–∫–æ–≤ (–æ–∫–æ–ª–æ 5.0‚Äì5.2) –≤—Ä–µ–º–µ–Ω–Ω–æ —Å–Ω–∏–∂–∞–µ—Ç **–≤–ª–∞–≥–æ—É–¥–µ—Ä–∂–∏–≤–∞—é—â—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å** (–í–£–°), –Ω–æ —Å–ø–æ—Å–æ–±—Å—Ç–≤—É–µ—Ç **—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—é –ø—Ä–æ—á–Ω–æ–π –≥–µ–ª–µ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã** –ø–æ—Å–ª–µ —Ç–µ—Ä–º–æ–æ–±—Ä–∞–±–æ—Ç–∫–∏.

            **–¶–µ–ª—å –ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è:** –¢–æ—á–Ω–æ–µ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–≥–æ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ pH.
        """)

    st.markdown("---")

    # --- –§–æ—Ä–º—É–ª–∞ pH –ú–æ–¥–µ–ª–∏ ---
    st.subheader("–§–æ—Ä–º—É–ª–∞ –∫–∏–Ω–µ—Ç–∏–∫–∏ pH (–ü–æ–¥–º–æ–¥–µ–ª—å —Å–æ–ª–µ–Ω–∏—è)")

    # pH –º–æ–¥–µ–ª—ñ–Ω—ñ“£ —Ñ–æ—Ä–º—É–ª–∞—Ç–∞—Å—ã–Ω –∏–º–∏—Ç–∞—Ü–∏—è–ª–∞—É (–ª–æ–≥–∏—Å—Ç–∏–∫–∞–ª—ã“õ –Ω–µ–º–µ—Å–µ –ø–æ–ª–∏–Ω–æ–º–∏–∞–ª–¥—ã)
    st.latex(r"""
        pH(t) = pH_0 - (pH_0 - pH_{\infty}) \cdot (1 - e^{-k \cdot t})
    """)
    st.markdown(r"""
        –ì–¥–µ:
        * $pH(t)$ - –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ pH –≤ –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ $t$.
        * $pH_0$ - –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ pH (–°—ã—Ä—å–µ).
        * $pH_{\infty}$ - –ê—Å–∏–º–ø—Ç–æ—Ç–∏—á–µ—Å–∫–æ–µ (–∫–æ–Ω–µ—á–Ω–æ–µ) –∑–Ω–∞—á–µ–Ω–∏–µ pH.
        * $k$ - –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞–∫–∏—Å–ª–µ–Ω–∏—è (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç $T$ –∏ $C$).
        * $t$ - –í—Ä–µ–º—è –ø–æ—Å–æ–ª–∞, —á–∞—Å.
    """)
    st.warning(
        "–ó–Ω–∞—á–µ–Ω–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã $k$ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –∏ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏ —Å–æ–ª–∏, —Å–æ–≥–ª–∞—Å–Ω–æ –≤–∞—à–µ–º—É —Ä–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω–æ–º—É –∞–Ω–∞–ª–∏–∑—É.")

    st.markdown("---")

    # --- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è —á–∞—Å—Ç—å –∏ –ü—Ä–æ–≥–Ω–æ–∑ ---
    st.subheader("‚öôÔ∏è –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –∏ –∞–Ω–∞–ª–∏–∑")


    # –ú–æ–¥–µ–ª—å–¥—ñ –µ—Å–µ–ø—Ç–µ—É “Ø—à—ñ–Ω –¥–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –∏–º–∏—Ç–∞—Ü–∏—è–ª–∞—É (–±“±—Ä—ã–Ω“ì—ã –∫–æ–¥—Ç–∞“ì—ã–¥–∞–π)

    # PH –º–æ–¥–µ–ª—ñ–Ω—ñ“£ —Ñ—É–Ω–∫—Ü–∏—è—Å—ã–Ω –±“±—Ä—ã–Ω“ì—ã –∫–æ–¥—Ç–∞–Ω “õ–∞–π—Ç–∞–ª–∞–π–º—ã–∑ (–µ–≥–µ—Ä –æ–ª –±–∞—Ä –±–æ–ª—Å–∞)
    # –ï–≥–µ—Ä –∫–æ–¥—Ç–∞ –±“±–ª —Ñ—É–Ω–∫—Ü–∏—è –±–æ–ª–º–∞—Å–∞, –±—ñ–∑ “õ–∞—Ä–∞–ø–∞–π—ã–º –ø–æ–ª–∏–Ω–æ–º–¥—ã “õ–æ–ª–¥–∞–Ω–∞–º—ã–∑:
    # y = -0.0001x^3 + 0.0075x^2 - 0.177x + 6.09 (–∏–¥–µ–∞–ª–¥—ã pH “õ–∏—Å—ã“ì—ã)

    def ph_model_func(t):
        if t < 0: return 0
        # –ö–æ–¥—Ç–∞“ì—ã –±–∞—Ä –Ω–∞“õ—Ç—ã –º–æ–¥–µ–ª—å–¥—ñ –ø–∞–π–¥–∞–ª–∞–Ω—É –∫–µ—Ä–µ–∫. –ú—ã—Å–∞–ª —Ä–µ—Ç—ñ–Ω–¥–µ:
        return 6.09 - 0.177 * t + 0.0075 * (t ** 2) - 0.0001 * (t ** 3)


    # ... (–û—Å—ã –∂–µ—Ä–¥–µ–Ω –±–∞—Å—Ç–∞–ø –±“±—Ä—ã–Ω“ì—ã –∫–æ–¥—Ç–∞“ì—ã–¥–∞–π —Å–ª–∞–π–¥–µ—Ä–ª–µ—Ä –º–µ–Ω –≥—Ä–∞—Ñ–∏–∫—Ç–µ—Ä –∂–∞–ª“ì–∞—Å–∞–¥—ã)

    # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤—Ç—ñ –ø—Ä–æ–≥–Ω–æ–∑ –±”©–ª—ñ–º—ñ
    t_input = st.slider("–í—Ä–µ–º—è –ø—Ä–æ–≥–Ω–æ–∑–∞ (t), —á–∞—Å", min_value=1, max_value=120, value=48, step=1)

    pH_forecast = ph_model_func(t_input)

    st.metric(
        label="–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π pH –≤ –∑–∞–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è",
        value=f"{pH_forecast:.2f}",
        delta=f"–†–∞–∑–Ω–∏—Ü–∞ –¥–æ —Ü–µ–ª–µ–≤–æ–≥–æ pH 5.6: {(pH_forecast - 5.6):.2f}",
        delta_color="inverse"
    )

    # --- “ö–æ—Ä—ã—Ç—ã–Ω–¥—ã ---
    if pH_forecast < 4.8:
        st.error(
            "**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫–∏—Å–ª–µ–Ω–∏–µ.** –ü—Ä–æ–¥—É–∫—Ç –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å —Å–ª–∏—à–∫–æ–º –∫–∏—Å–ª—ã–º, —á—Ç–æ –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ —Å–∫–∞–∂–µ—Ç—Å—è –Ω–∞ –≤–∫—É—Å–µ –∏ –í–£–°.")
    elif 4.8 <= pH_forecast <= 5.6:
        st.success("**–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω.** –ü—Ä–æ–¥—É–∫—Ç –±–µ–∑–æ–ø–∞—Å–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç–∞–¥–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (—Ç–µ—Ä–º–æ–æ–±—Ä–∞–±–æ—Ç–∫–∞).")
    elif pH_forecast > 5.6:
        st.warning(
            "**–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –∑–∞–∫–∏—Å–ª–µ–Ω–∏–µ.** –†–∏—Å–∫ —Ä–∞–∑–≤–∏—Ç–∏—è –ø–∞—Ç–æ–≥–µ–Ω–Ω–æ–π –º–∏–∫—Ä–æ—Ñ–ª–æ—Ä—ã. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–≤–µ–ª–∏—á–∏—Ç—å –≤—Ä–µ–º—è –ø–æ—Å–æ–ª–∞.")

    st.markdown("---")
    st.subheader("–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∫–∏–Ω–µ—Ç–∏–∫–∏ pH")
    # ... (–≥—Ä–∞—Ñ–∏–∫ —Å–∞–ª—É –∫–æ–¥—ã –∂–∞–ª“ì–∞—Å–∞–¥—ã, –æ–Ω–¥–∞ X –æ—Å—ñ–Ω–¥–µ —É–∞“õ—ã—Ç, Y –æ—Å—ñ–Ω–¥–µ pH)

    # –ì—Ä–∞—Ñ–∏–∫ —Å–∞–ª—É –∫–æ–¥—ã–Ω—ã“£ –º—ã—Å–∞–ª—ã
    times = np.linspace(0, 120, 100)
    pH_values = [ph_model_func(t) for t in times]

    fig, ax = plt.subplots(figsize=(10, 5))
    ax.plot(times, pH_values, label='–ü—Ä–æ–≥–Ω–æ–∑ pH', color='#B71C1C', linewidth=3)
    ax.axhspan(4.8, 5.6, color='green', alpha=0.1, label='–¶–µ–ª–µ–≤–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω')
    ax.axvline(t_input, color='black', linestyle='--', alpha=0.6, label=f'–ü—Ä–æ–≥–Ω–æ–∑ ({t_input} —á)')
    ax.set_title('–ö–∏–Ω–µ—Ç–∏–∫–∞ pH –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–æ—Å–æ–ª–∞', fontsize=16)
    ax.set_xlabel('–í—Ä–µ–º—è –ø–æ—Å–æ–ª–∞, —á–∞—Å')
    ax.set_ylabel('–ó–Ω–∞—á–µ–Ω–∏–µ pH')
    ax.legend()
    ax.grid(True, linestyle=':', alpha=0.7)
    st.pyplot(fig)

    st.caption("–ì—Ä–∞—Ñ–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ –±—ã—Å—Ç—Ä–æ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –∫–∏—Å–ª–æ—Ç–Ω–æ—Å—Ç–∏.")

# ==========================================================================
# –°–¢–†–ê–ù–ò–¶–ê 5: –ê–ù–ê–õ–ò–ó –° –≠–ö–°–¢–†–ê–ö–¢–û–ú –û–ë–õ–ï–ü–ò–•–ò (–ü–û–õ–ù–û–°–¢–¨–Æ –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –†–ê–ó–î–ï–õ)
# ==========================================================================
elif page == "–ê–Ω–∞–ª–∏–∑ —Å —ç–∫—Å—Ç—Ä–∞–∫—Ç–æ–º –æ–±–ª–µ–ø–∏—Ö–∏":
    st.title("üî¨ –í–ª–∏—è–Ω–∏–µ —ç–∫—Å—Ç—Ä–∞–∫—Ç–∞ –æ–±–ª–µ–ø–∏—Ö–∏ –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ –∂–∞—è –∏ —Ñ–æ—Ä–º–æ–≤–∞–Ω–Ω–æ–≥–æ –º—è—Å–∞")
    st.write(
        "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é —ç–∫—Å—Ç—Ä–∞–∫—Ç–∞ –æ–±–ª–µ–ø–∏—Ö–∏ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è—Ö –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏ –∞–Ω—Ç–∏–æ–∫–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–≤–æ–π—Å—Ç–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤.")

    st.markdown("---")

    # --- –ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã ---
    st.subheader("–¢–∞–±–ª–∏—Ü–∞ 1. –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∫–æ–ø—á—ë–Ω–æ–π –∂–∞—è (–∫–æ–Ω—Ç—Ä–æ–ª—å –∏ 5% —ç–∫—Å—Ç—Ä–∞–∫—Ç–∞)")
    table1_data = {
        "–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": ["–ú–∞—Å—Å–æ–≤–∞—è –¥–æ–ª—è –≤–ª–∞–≥–∏, %", "–ë–µ–ª–æ–∫, %", "–ñ–∏—Ä, %",
                       "–í–ª–∞–≥–æ—É–¥–µ—Ä–∂. —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å (–í–£–°), %", "–¢–ë–ß, –º–≥/–∫–≥"],
        "–ö–æ–Ω—Ç—Ä–æ–ª—å (0%)": [65.2, 21.2, 31.06, 60.2, 0.69],
        "–ñ–∞—è + 5% —ç–∫—Å—Ç—Ä–∞–∫—Ç–∞": [67.8, 25.44, 33.4, 67.4, 0.96]
    }
    df_table1 = pd.DataFrame(table1_data)
    st.dataframe(df_table1)

    st.subheader("–¢–∞–±–ª–∏—Ü–∞ 2. –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Ñ–æ—Ä–º–æ–≤–∞–Ω–Ω–æ–≥–æ –º—è—Å–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ (–∫–æ–Ω—Ç—Ä–æ–ª—å –∏ 3% —ç–∫—Å—Ç—Ä–∞–∫—Ç–∞)")
    table2_data = {
        "–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": ["–ú–∞—Å—Å–æ–≤–∞—è –¥–æ–ª—è –≤–ª–∞–≥–∏, %", "–ë–µ–ª–æ–∫, %", "–ñ–∏—Ä, %", "NaCl, %", "–ó–æ–ª–∞, %"],
        "–ö–æ–Ω—Ç—Ä–æ–ª—å (0%)": [68.96, 13.60, 11.03, 1.77, 2.96],
        "–§–æ—Ä–º–æ–≤–∞–Ω–Ω–æ–µ –º—è—Å–æ + 3% —ç–∫—Å—Ç—Ä–∞–∫—Ç–∞": [70.08, 13.88, 8.51, 1.27, 2.22]
    }
    df_table2 = pd.DataFrame(table2_data)
    st.dataframe(df_table2)

    st.markdown("---")

    # --- –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ ---
    col1, col2 = st.columns(2)
    x_ticks = np.arange(0, 15.1, 2.5)

    with col1:
        # –†–∏—Å. 1 ‚Äî –í–ª–∞–≥–∞ –≤ –∂–∞—è
        st.subheader("–†–∏—Å. 1. –í–ª–∏—è–Ω–∏–µ —ç–∫—Å—Ç—Ä–∞–∫—Ç–∞ –Ω–∞ –≤–ª–∞–≥–æ—Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∂–∞—è")
        x = np.array([0, 3, 5, 7, 9, 15])
        vlaga = np.array([65.2, 66.8, 68.9, 68.6, 67.8, 65.4])
        fig1, ax1 = plt.subplots(figsize=(8, 5))
        ax1.plot(x, vlaga, 'o-b', linewidth=2, markersize=6)
        ax1.set_xlabel("–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è —ç–∫—Å—Ç—Ä–∞–∫—Ç–∞ –æ–±–ª–µ–ø–∏—Ö–∏ –≤ —Ä–∞—Å—Å–æ–ª–µ, %")
        ax1.set_ylabel("–ú–∞—Å—Å–æ–≤–∞—è –¥–æ–ª—è –≤–ª–∞–≥–∏ –≤ –∂–∞—è, %")
        ax1.set_title("–í–ª–∏—è–Ω–∏–µ —ç–∫—Å—Ç—Ä–∞–∫—Ç–∞ –æ–±–ª–µ–ø–∏—Ö–∏ –Ω–∞ –≤–ª–∞–≥–æ—Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∂–∞—è")
        ax1.set_xticks(x_ticks)
        ax1.grid(True, linestyle=":")
        st.pyplot(fig1)

        # –†–∏—Å. 3 ‚Äî –í–£–°, –í–°–°, –ñ–£–°
        st.subheader("–†–∏—Å. 3. –í–£–°, –í–°–° –∏ –ñ–£–° –∫–æ–ø—á—ë–Ω–æ–π –∂–∞—è")
        VUS = np.array([60.2, 64.3, 67.4, 71.2, 73.5, 78.9])
        VSS = np.array([61.0, 65.5, 70.1, 73.8, 75.2, 77.4])
        ZhUS = np.array([60.0, 63.1, 66.8, 70.0, 72.5, 74.8])
        fig3, ax3 = plt.subplots(figsize=(8, 5))
        ax3.plot(x, VUS, 'o-', color='orange', label='–í–£–°, %')
        ax3.plot(x, VSS, 'd-', color='gold', label='–í–°–°, %')
        ax3.plot(x, ZhUS, 's-', color='deeppink', label='–ñ–£–°, %')
        ax3.set_xlabel("–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è —ç–∫—Å—Ç—Ä–∞–∫—Ç–∞ –æ–±–ª–µ–ø–∏—Ö–∏ –≤ —Ä–∞—Å—Å–æ–ª–µ, %")
        ax3.set_ylabel("–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å, %")
        ax3.set_title("–í–£–°, –í–°–° –∏ –ñ–£–° –∫–æ–ø—á—ë–Ω–æ–π –∂–∞—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —ç–∫—Å—Ç—Ä–∞–∫—Ç–∞")
        ax3.set_xticks(x_ticks)
        ax3.legend()
        ax3.grid(True, linestyle=":")
        st.pyplot(fig3)

        # –†–∏—Å. 5 ‚Äî –§–æ—Ä–º–æ–≤–∞–Ω–Ω–æ–µ –º—è—Å–æ
        st.subheader("–†–∏—Å. 5. –û–∫–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Ñ–æ—Ä–º–æ–≤–∞–Ω–Ω–æ–≥–æ –º—è—Å–∞")
        days2 = np.array([5, 10, 15])
        tbch_c2 = np.array([0.203, 0.284, 0.312])
        tbch_e2 = np.array([0.254, 0.366, 0.428])
        perox_c2 = np.array([13.27, 14.30, 15.21])
        perox_e2 = np.array([9.90, 10.80, 11.60])
        fig5, ax5 = plt.subplots(figsize=(8, 5))
        ax5.plot(days2, tbch_c2, 'o--', color='blue', label='–¢–ë–ß –∫–æ–Ω—Ç—Ä–æ–ª—å')
        ax5.plot(days2, tbch_e2, 's--', color='deepskyblue', label='–¢–ë–ß 3 % —ç–∫—Å—Ç—Ä')
        ax5.plot(days2, perox_c2, 'o-', color='red', label='–ü–µ—Ä–µ–∫–∏—Å–Ω–æ–µ —á. –∫–æ–Ω—Ç—Ä–æ–ª—å')
        ax5.plot(days2, perox_e2, 's-', color='tomato', label='–ü–µ—Ä–µ–∫–∏—Å–Ω–æ–µ —á. 3 % —ç–∫—Å—Ç—Ä')
        ax5.set_xlabel("–í—Ä–µ–º—è —Ö—Ä–∞–Ω–µ–Ω–∏—è, —Å—É—Ç")
        ax5.set_ylabel("–ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è")
        ax5.set_title("–û–∫–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Ñ–æ—Ä–º–æ–≤–∞–Ω–Ω–æ–≥–æ –º—è—Å–∞ –ø—Ä–∏ —Ö—Ä–∞–Ω–µ–Ω–∏–∏ (0‚Äì4 ¬∞C)")
        ax5.set_xticks(days2)
        ax5.legend()
        ax5.grid(True, linestyle=":")
        st.pyplot(fig5)

    with col2:
        # –†–∏—Å. 2 ‚Äî –ë–µ–ª–æ–∫ –∏ –∂–∏—Ä
        st.subheader("–†–∏—Å. 2. –ë–µ–ª–æ–∫ –∏ –∂–∏—Ä –≤ –∂–∞—è")
        belok = np.array([21.2, 23.4, 25.4, 27.5, 29.8, 34.9])
        zhir = np.array([31.06, 32.4, 33.4, 37.1, 41.2, 45.0])
        fig2, ax2 = plt.subplots(figsize=(8, 5))
        ax2.plot(x, belok, 's-g', linewidth=2, markersize=6, label="–ë–µ–ª–æ–∫, %")
        ax2.plot(x, zhir, '^r-', linewidth=2, markersize=6, label="–ñ–∏—Ä, %")
        ax2.set_xlabel("–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è —ç–∫—Å—Ç—Ä–∞–∫—Ç–∞ –æ–±–ª–µ–ø–∏—Ö–∏, %")
        ax2.set_ylabel("–ú–∞—Å—Å–æ–≤–∞—è –¥–æ–ª—è, %")
        ax2.set_title("–ë–µ–ª–æ–∫ –∏ –∂–∏—Ä –≤ –∂–∞—è –ø—Ä–∏ —Ä–∞–∑–Ω—ã—Ö –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è—Ö —ç–∫—Å—Ç—Ä–∞–∫—Ç–∞")
        ax2.set_xticks(x_ticks)
        ax2.legend()
        ax2.grid(True, linestyle=":")
        st.pyplot(fig2)

        # –†–∏—Å. 4 ‚Äî –û–∫–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∂–∞—è
        st.subheader("–†–∏—Å. 4. –û–∫–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∂–∞—è")
        days = np.array([5, 10, 15])
        tbch_c = np.array([0.197, 0.376, 0.416])
        tbch_e = np.array([0.194, 0.361, 0.419])
        perox_c = np.array([17.96, 19.12, 20.25])
        perox_e = np.array([13.01, 14.40, 15.13])
        fig4, ax4 = plt.subplots(figsize=(8, 5))
        ax4.plot(days, tbch_c, 'o--', color='blue', label='–¢–ë–ß –∫–æ–Ω—Ç—Ä–æ–ª—å')
        ax4.plot(days, tbch_e, 's--', color='deepskyblue', label='–¢–ë–ß 3 % —ç–∫—Å—Ç—Ä')
        ax4.plot(days, perox_c, 'o-', color='red', label='–ü–µ—Ä–µ–∫–∏—Å–Ω–æ–µ —á. –∫–æ–Ω—Ç—Ä–æ–ª—å')
        ax4.plot(days, perox_e, 's-', color='tomato', label='–ü–µ—Ä–µ–∫–∏—Å–Ω–æ–µ —á. 3 % —ç–∫—Å—Ç—Ä')
        ax4.set_xlabel("–í—Ä–µ–º—è —Ö—Ä–∞–Ω–µ–Ω–∏—è, —Å—É—Ç")
        ax4.set_ylabel("–ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è")
        ax4.set_title("–û–∫–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∂–∞—è –ø—Ä–∏ —Ö—Ä–∞–Ω–µ–Ω–∏–∏ (0‚Äì3 ¬∞C)")
        ax4.set_xticks(days)
        ax4.legend()
        ax4.grid(True, linestyle=":")
        st.pyplot(fig4)


# ==========================================================================
# –°–¢–†–ê–ù–ò–¶–ê 6: –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï –î–ê–ù–ù–´–•
# ==========================================================================
elif page == "–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö":
    st.title("üóÇÔ∏è –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö")
    st.write("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.")

    if all_meat_data:
        available_tables = list(all_meat_data.keys())
        if df_ph is not None:
            available_tables.append('opyty.xlsx')

        choice = st.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ:", available_tables)

        st.markdown(f"**–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑: `{choice}`**")

        if choice == 'opyty.xlsx':
            if df_ph is not None:
                df_to_show = df_ph.copy()
            else:
                df_to_show = pd.DataFrame()
        else:
            df_to_show = all_meat_data[choice].copy()

        if 'Accuracy' in df_to_show.columns:
            df_to_show['Accuracy'] = pd.to_numeric(df_to_show['Accuracy'], errors='coerce')

        if not df_to_show.empty:
            st.dataframe(df_to_show)
        else:
            st.warning(f"–î–∞–Ω–Ω—ã–µ –¥–ª—è '{choice}' –Ω–µ –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–ª–∏ –ø—É—Å—Ç—ã.")

    else:
        st.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.")
#streamlit run new.py –¥–ª—è –∑–∞–ø—É—Å–∫–∞